<!DOCTYPE html>
<html lang="en">

<head>
  <title>Finance-tracker</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div id="app" v-cloak>
    <nav class="navbar navbar-expand-sm navbar-dark bg-dark">
      <div class="container">
        <div class="collapse navbar-collapse" id="mynavbar">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link" href="#">Finance Tracker</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">Dashboard</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">Transactions</a>
            </li>
          </ul>
          <div class="dropdown">
            <button class="btn btn-dark dropdown-toggle" type="button" id="dropdownMenuButton1"
              data-bs-toggle="dropdown" aria-expanded="false">
              Finance-tracker
            </button>
            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
              <li class="dropdown-item">{{fullName}}</li>
              <li class="dropdown-item">{{user.email}}</li>
              <li class="dropdown-item">Date of birth: {{user.dob}}</li>
              <li class="dropdown-item" v-on:click="logout()"><a href="#">logout</a></li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <section>
      <div class="container">
        <div class="row mt-5">
          <div class="col-sm">
            <h2>Hello {{fullName}}</h2>
            <p>What do you want to record today?</p>
          </div>


          <div class="col-sm d-flex justify-content-end">
            <div class="Total-Expense mx-1 text-center">
              <p><span class="text-success fw-bold h4">{{income}}</span><br>Total Income </span></p>
            </div>

            <div class="Total-Expense mx-1 text-center">
              <p><span class="text-danger fw-bold h4">{{expense}}</span><br>Total Expense </span></p>
            </div>

            <div class="Total-Expense mx-1 text-center">
              <p><span class="text-primary fw-bold h4">{{netIncome}}</span><br>Net Income </p>
            </div>
          </div>
        </div>


        <div class="row mt-5">
          <div class="col-sm mb-3 d-flex">
          </div>

          <div class="d-flex justify-content-end col-sm">
            <div>
              <button class="btn btn-dark mb-3" style="border-radius:20px" data-bs-toggle="modal"
                data-bs-target="#addDialog"><i class="fa fa-plus-circle" aria-hidden="true"></i> Add Transaction
              </button>
            </div>
          </div>

        </div>

        <div class=" container transaction-1 mb-5">
          <table class="table">
            <thead>
              <tr>
                <th scope="col">#</th>
                <th scope="col">Type</th>
                <th scope="col">Description</th>
                <th scope="col">Amount</th>
                <th scope="col"></th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="(trans, index) in transactions">
                <td>{{index + 1}}</td>
                <td><span class="badge"
                    v-bind:class="{'bg-success': trans.recordType == 'income', 'bg-danger': trans.recordType == 'expense'}">
                    {{trans.recordType.toUpperCase()}}
                  </span></td>
                <td>{{trans.description}}</td>
                <td>{{trans.amount}}</td>
                <td>
                  <button class="btn btn-danger" v-on:click="deleteTransaction(trans.transId)"><i class="fa fa-trash"
                      aria-hidden="true"></i></button>
                </td>
              </tr>
            </tbody>
          </table>

        </div>

      </div>
    </section>
    <!-- Modal -->
    <div class="modal fade" id="addDialog" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
      aria-labelledby="addDialogLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addDialogLabel">Add Income/Expense</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div v-show="feedback" class="alert alert-success my-3 " role="alert">
              {{feedback}}
            </div>
            <div class="mb-3 mt-3">
              <label for="recordType">Select Record Type:</label>
              <select v-model="recordType" class="form-select">
                <option value="income">Income</option>
                <option value="expense">Expense</option>
              </select>
            </div>
            <div class="mb-3 mt-3">
              <label for="amount" class="form-label">Amount:</label>
              <input type="text" class="form-control" v-model="amount" placeholder="Enter Amount" name="amount">
            </div>

            <div class="mb-3 mt-3">
              <label for="description" class="form-label">Description:</label>
              <input type="text" class="form-control" v-model="description" placeholder="Enter Description"
                name="description">
            </div>

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" v-on:click="saveNew()">Save</button>

          </div>
        </div>
      </div>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>


  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script>
    const loginUser = localStorage.getItem("loginUser");
    if (!loginUser) {
      window.location = "login.html";
    }
    const user = JSON.parse(loginUser);
    const transactions = JSON.parse(localStorage.getItem('transactions')) || [];
    const { income, expense } = calculateIncomeExpense(transactions);

    const app = Vue.createApp({
      data() {
        return {
          user: user,
          transactions: transactions,
          feedback: "",
          income: income,
          expense: expense,
          recordType: "income",
          description: "",
          amount: 0
        }
      },
      computed: {
        fullName() {
          return this.user.first_name + " " + this.user.last_name
        },
        netIncome() {
          return this.income - this.expense
        },
      },
      watch: {
        transactions: {
          deep: true,
          handler(txns) {
            const { income, expense } = calculateIncomeExpense(txns);
            this.income = income;
            this.expense = expense;
          }
        }
      },


      methods: {
        saveNew() {
          if (this.recordType === '') {
            this.feedback = 'Please select a record type!';
          } else if (this.amount === '') {
            this.feedback = 'Please enter an amount!';
          } else if (this.description === '') {
            this.feedback = 'Please enter a description!';
          } else {
            const transaction = {
              transId: Date.now().toString(),
              recordType: this.recordType,
              amount: this.amount,
              description: this.description
            };
            this.transactions.push(transaction);
            localStorage.setItem('transactions', JSON.stringify(this.transactions));

            this.feedback = 'Transaction saved successfully!';

          }
        },
        deleteTransaction(transId) {
          this.transactions = this.transactions.filter((trans) => trans.transId !== transId);
          localStorage.setItem('transactions', JSON.stringify(this.transactions));
        }
      }

    });
    app.mount('#app');

    function calculateIncomeExpense(transactions) {
      let income = 0;
      let expense = 0;
      for (transaction of transactions) {
        if (transaction.recordType === "income") {
          income = income + Number(transaction.amount);
        }
        else {
          expense = expense + Number(transaction.amount);
        }
      }

      return {
        income, expense
      }
    }
  </script>
  </div>
</body>

</html>